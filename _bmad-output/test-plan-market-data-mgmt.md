---
title: 行情数据管理功能 - 测试计划与回归清单
author: wallace
date: 2026-02-26
version: 1.0
status: Draft
related_docs:
  - prd-market-data-mgmt.md
  - arch-market-data-mgmt.md
  - brief-market-data-mgmt.md
---

# 行情数据管理功能 - 测试计划与回归清单

## 1. 测试概述

### 1.1 测试目标

验证行情数据管理功能的完整性、可靠性和安全性，确保新功能不影响现有系统，并覆盖所有关键场景和失败路径。

### 1.2 测试范围

**功能范围**：
- 数据全景展示
- 手动下载（增量更新、全量下载）
- 下载配置（定时任务）
- 进度追踪与任务管理
- 数据分析与统计

**非功能范围**：
- 任务并发控制
- 失败恢复与重试
- 权限与路径管理
- API 安全性

### 1.3 测试策略

- **P0（关键）**：核心功能、安全性、非回归 - 每次提交必测
- **P1（高）**：重要功能、常见场景 - PR 合并前必测
- **P2（中）**：边缘场景、错误处理 - 每日回归
- **P3（低）**：探索性测试、性能基准 - 按需执行

### 1.4 测试环境

- **开发环境**：本地 Docker 容器
- **测试环境**：独立测试容器，模拟生产配置
- **数据环境**：测试用 bundle 数据（小规模）

---

## 2. 非回归测试（冒烟测试）

### 2.1 测试目标

确保新增的行情数据管理功能不影响现有系统的核心功能。

### 2.2 测试用例

#### TC-REG-001: 登录功能正常

**优先级**: P0
**前置条件**: 应用已启动，数据库已初始化
**测试步骤**:
1. 访问登录页面 `/login`
2. 输入有效的用户名和密码
3. 点击登录按钮

**预期结果**:
- 登录成功，跳转到主页
- 用户会话正常建立
- 响应时间 < 2 秒

**风险**: 高 - 登录是所有功能的入口

---

#### TC-REG-002: 回测工作台正常

**优先级**: P0
**前置条件**: 用户已登录
**测试步骤**:
1. 导航到回测工作台
2. 加载策略列表
3. 选择一个策略
4. 查看策略详情

**预期结果**:
- 回测工作台页面正常加载
- 策略列表正确显示
- 策略详情可正常查看
- 无 JavaScript 错误

**风险**: 高 - 核心业务功能

---

#### TC-REG-003: 研究工作台正常

**优先级**: P0
**前置条件**: 用户已登录
**测试步骤**:
1. 导航到研究工作台
2. 访问 Jupyter Notebook 代理
3. 创建新的 Notebook
4. 执行简单的 Python 代码

**预期结果**:
- 研究工作台页面正常加载
- Jupyter 代理连接正常
- Notebook 可正常创建和执行
- 无连接错误

**风险**: 高 - 核心业务功能

---

#### TC-REG-004: 导航栏新增入口

**优先级**: P1
**前置条件**: 用户已登录
**测试步骤**:
1. 查看导航栏
2. 确认"行情数据管理"入口位置
3. 点击"行情数据管理"

**预期结果**:
- "行情数据管理"入口在"研究工作台"后面
- 点击后跳转到 `/market-data` 页面
- 页面正常加载

**风险**: 中 - UI 集成

---

## 3. "当月已最新"弹框逻辑测试

### 3.1 测试目标

验证系统能正确检测 bundle 最近修改时间，并在当月已更新时提示用户确认。

### 3.2 测试用例

#### TC-CONFIRM-001: 增量更新 - 当月已更新，显示确认弹框

**优先级**: P0
**前置条件**:
- bundle 目录存在
- bundle 中有文件的修改时间在当前月份

**测试步骤**:
1. 点击"增量更新"按钮
2. 观察前端响应

**预期结果**:
- 后端返回 `need_confirm: true`
- 前端显示确认弹框："检测到当月已有更新，确定要再次更新吗？"
- 弹框有"取消"和"确定"两个按钮

**验证点**:
- API 响应: `{"need_confirm": true, "message": "..."}`
- HTTP 状态码: 200

**风险**: 高 - 防止重复下载

---

#### TC-CONFIRM-002: 增量更新 - 用户取消操作

**优先级**: P1
**前置条件**: TC-CONFIRM-001 的弹框已显示
**测试步骤**:
1. 点击"取消"按钮

**预期结果**:
- 弹框关闭
- 不触发下载任务
- 无 API 请求发送

**风险**: 中 - 用户体验

---

#### TC-CONFIRM-003: 增量更新 - 用户确认后强制执行

**优先级**: P0
**前置条件**: TC-CONFIRM-001 的弹框已显示
**测试步骤**:
1. 点击"确定"按钮
2. 观察任务提交

**预期结果**:
- 发送 POST 请求，参数 `force: true`
- 后端返回 `task_id`
- HTTP 状态码: 202
- 任务开始执行

**验证点**:
- 请求体: `{"force": true}`
- 响应: `{"task_id": "uuid"}`

**风险**: 高 - 核心流程

---

#### TC-CONFIRM-004: 全量下载 - 当月已更新，显示确认弹框

**优先级**: P0
**前置条件**:
- bundle 目录存在
- bundle 中有文件的修改时间在当前月份

**测试步骤**:
1. 点击"全量下载"按钮
2. 观察前端响应

**预期结果**:
- 后端返回 `need_confirm: true`
- 前端显示确认弹框："检测到当月已有更新，确定要重新下载吗？"
- 弹框有"取消"和"确定"两个按钮

**风险**: 高 - 防止重复下载

---

#### TC-CONFIRM-005: 全量下载 - 用户确认后强制执行

**优先级**: P0
**前置条件**: TC-CONFIRM-004 的弹框已显示
**测试步骤**:
1. 点击"确定"按钮
2. 观察任务提交

**预期结果**:
- 发送 POST 请求，参数 `force: true`
- 后端返回 `task_id`
- HTTP 状态码: 202
- 任务开始执行

**风险**: 高 - 核心流程

---

#### TC-CONFIRM-006: 非当月数据，直接执行不弹框

**优先级**: P1
**前置条件**:
- bundle 目录不存在，或
- bundle 中所有文件的修改时间不在当前月份

**测试步骤**:
1. 点击"增量更新"或"全量下载"按钮

**预期结果**:
- 不显示确认弹框
- 直接返回 `task_id`
- HTTP 状态码: 202
- 任务开始执行

**风险**: 中 - 正常流程

---

## 4. 进度追踪准确性测试

### 4.1 测试目标

验证下载、解压、分析三个阶段的进度百分比单调递增，阶段切换正确，进度条实时更新。

### 4.2 测试用例

#### TC-PROGRESS-001: 下载进度百分比单调递增

**优先级**: P0
**前置条件**: 全量下载或增量更新任务已提交
**测试步骤**:
1. 获取 task_id
2. 每秒轮询 `GET /api/market-data/tasks/{task_id}`
3. 记录每次返回的 `progress` 值

**预期结果**:
- `stage` 为 `download`
- `progress` 从 0 开始递增到 100
- 每次轮询的 `progress` 值 >= 上次值（单调递增）
- `message` 显示下载进度信息

**验证点**:
- 进度值范围: 0-100
- 单调性: progress[i] >= progress[i-1]

**风险**: 高 - 用户体验关键

---

#### TC-PROGRESS-002: 解压进度百分比单调递增（全量下载）

**优先级**: P0
**前置条件**: 全量下载任务的下载阶段已完成
**测试步骤**:
1. 继续轮询任务状态
2. 观察阶段切换到 `unzip`
3. 记录解压阶段的 `progress` 值

**预期结果**:
- `stage` 从 `download` 切换到 `unzip`
- `progress` 从 0 重新开始递增到 100
- 每次轮询的 `progress` 值 >= 上次值
- `message` 显示解压进度信息

**验证点**:
- 阶段切换正确
- 进度重置后单调递增

**风险**: 高 - 用户体验关键

---

#### TC-PROGRESS-003: 分析进度百分比单调递增

**优先级**: P0
**前置条件**:
- 全量下载任务的解压阶段已完成，或
- 增量更新任务的下载阶段已完成

**测试步骤**:
1. 继续轮询任务状态
2. 观察阶段切换到 `analyze`
3. 记录分析阶段的 `progress` 值

**预期结果**:
- `stage` 切换到 `analyze`
- `progress` 从 0 重新开始递增到 100
- 每次轮询的 `progress` 值 >= 上次值
- `message` 显示分析进度信息（如"正在解析股票数据..."）

**验证点**:
- 阶段切换正确
- 进度单调递增
- 消息内容有意义

**风险**: 高 - 用户体验关键

---

#### TC-PROGRESS-004: 阶段切换顺序正确

**优先级**: P0
**前置条件**: 全量下载任务已提交
**测试步骤**:
1. 轮询任务状态
2. 记录所有 `stage` 变化

**预期结果**:
- 阶段顺序: `download` → `unzip` → `analyze`
- 不会跳过阶段
- 不会倒退到前一阶段

**验证点**:
- 阶段序列: ['download', 'unzip', 'analyze']
- 无重复或乱序

**风险**: 高 - 逻辑正确性

---

#### TC-PROGRESS-005: 增量更新无解压阶段

**优先级**: P1
**前置条件**: 增量更新任务已提交
**测试步骤**:
1. 轮询任务状态
2. 记录所有 `stage` 变化

**预期结果**:
- 阶段顺序: `download` → `analyze`
- 不包含 `unzip` 阶段

**验证点**:
- 阶段序列: ['download', 'analyze']

**风险**: 中 - 业务逻辑

---

#### TC-PROGRESS-006: 进度条实时更新（前端）

**优先级**: P1
**前置条件**: 任务正在执行
**测试步骤**:
1. 观察前端进度条
2. 确认进度条随轮询更新

**预期结果**:
- 进度条视觉上平滑递增
- 百分比数字与进度条一致
- 阶段提示文字正确显示
- 无卡顿或跳跃

**风险**: 中 - 用户体验

---

## 5. 任务互斥测试

### 5.1 测试目标

验证系统能正确实现任务互斥，同一时间只允许一个任务运行。

### 5.2 测试用例

#### TC-MUTEX-001: 并发点击下载按钮，只有一个任务执行

**优先级**: P0
**前置条件**: 无正在运行的任务
**测试步骤**:
1. 快速连续点击"全量下载"按钮 3 次
2. 观察后端响应和任务状态

**预期结果**:
- 第一次点击返回 `task_id`，HTTP 202
- 第二次和第三次点击返回错误，HTTP 409
- 错误消息："已有任务正在运行，请等待完成后再试"
- 数据库中只有一个任务记录为 `running` 状态

**验证点**:
- 数据库查询: `SELECT COUNT(*) FROM market_data_tasks WHERE status IN ('pending', 'running')` = 1
- 并发控制正确

**风险**: 高 - 防止资源竞争

---

#### TC-MUTEX-002: 下载中再次点击，提示互斥

**优先级**: P0
**前置条件**: 有一个下载任务正在运行
**测试步骤**:
1. 点击"增量更新"按钮
2. 观察响应

**预期结果**:
- HTTP 状态码: 409
- 响应: `{"error": "已有任务正在运行，请等待完成后再试"}`
- 前端显示友好提示

**风险**: 高 - 用户体验

---

#### TC-MUTEX-003: 分析中触发下载，提示互斥

**优先级**: P0
**前置条件**: 有一个分析任务正在运行
**测试步骤**:
1. 点击"全量下载"按钮
2. 观察响应

**预期结果**:
- HTTP 状态码: 409
- 响应: `{"error": "已有任务正在运行，请等待完成后再试"}`
- 不创建新任务

**风险**: 高 - 任务管理

---

#### TC-MUTEX-004: 任务完成后可再次提交

**优先级**: P1
**前置条件**: 有一个任务已完成（status = 'success' 或 'failed'）
**测试步骤**:
1. 点击"增量更新"按钮
2. 观察响应

**预期结果**:
- HTTP 状态码: 202
- 返回新的 `task_id`
- 新任务开始执行

**风险**: 中 - 正常流程

---

#### TC-MUTEX-005: 手动分析与自动分析互斥

**优先级**: P1
**前置条件**: 全量下载任务正在执行，即将触发自动分析
**测试步骤**:
1. 在下载完成前，手动点击"触发分析"按钮
2. 观察响应

**预期结果**:
- 如果下载任务还在运行，返回 409 错误
- 如果下载任务已完成但自动分析未开始，手动分析成功提交
- 如果自动分析已开始，返回 409 错误

**风险**: 中 - 边缘场景

---

## 6. 定时任务配置测试

### 6.1 测试目标

验证定时任务配置的读取、更新、启用/禁用功能，以及运行日志的正确记录。

### 6.2 测试用例

#### TC-CRON-001: 读取默认定时配置

**优先级**: P1
**前置条件**: 数据库中无定时配置记录
**测试步骤**:
1. 发送 `GET /api/market-data/cron/config`

**预期结果**:
- HTTP 状态码: 200
- 返回默认配置:
  ```json
  {
    "enabled": false,
    "cron_expression": "0 2 1 * *",
    "task_type": "incremental"
  }
  ```

**风险**: 低 - 默认配置

---

#### TC-CRON-002: 更新定时配置

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 发送 `PUT /api/market-data/cron/config`
2. 请求体:
   ```json
   {
     "enabled": true,
     "cron_expression": "0 3 1 * *",
     "task_type": "full"
   }
   ```

**预期结果**:
- HTTP 状态码: 200
- 响应: `{"message": "配置已更新"}`
- 数据库中配置已更新
- APScheduler 调度器已更新

**验证点**:
- 数据库查询: `SELECT * FROM market_data_cron_config WHERE id = 1`
- 配置值正确

**风险**: 高 - 核心功能

---

#### TC-CRON-003: 启用定时任务

**优先级**: P0
**前置条件**: 定时任务配置为禁用状态
**测试步骤**:
1. 更新配置，设置 `enabled: true`
2. 等待到达 cron 触发时间（或手动触发调度器）

**预期结果**:
- 调度器在指定时间触发任务
- 任务成功提交
- 运行日志正确记录

**验证点**:
- 日志表: `SELECT * FROM market_data_cron_logs ORDER BY trigger_time DESC LIMIT 1`
- status = 'success'

**风险**: 高 - 自动化功能

---

#### TC-CRON-004: 禁用定时任务

**优先级**: P1
**前置条件**: 定时任务配置为启用状态
**测试步骤**:
1. 更新配置，设置 `enabled: false`
2. 等待到达 cron 触发时间

**预期结果**:
- 调度器不触发任务
- 或触发后检查配置，跳过执行
- 运行日志记录 status = 'skipped'

**风险**: 中 - 控制功能

---

#### TC-CRON-005: 定时任务日志正确记录

**优先级**: P1
**前置条件**: 定时任务已触发
**测试步骤**:
1. 发送 `GET /api/market-data/cron/logs?limit=10`
2. 查看日志列表

**预期结果**:
- HTTP 状态码: 200
- 返回日志列表，包含:
  - log_id
  - task_id（如果任务已提交）
  - trigger_time
  - status（success/failed/skipped）
  - message
- 日志按时间倒序排列

**风险**: 中 - 可观测性

---

#### TC-CRON-006: 获取日志详情

**优先级**: P2
**前置条件**: 日志表中有记录
**测试步骤**:
1. 获取一个 log_id
2. 发送 `GET /api/market-data/cron/logs/{log_id}`

**预期结果**:
- HTTP 状态码: 200
- 返回日志详情
- 如果有关联任务，包含任务详情

**风险**: 低 - 辅助功能

---

#### TC-CRON-007: 定时任务与手动任务互斥

**优先级**: P0
**前置条件**: 有手动任务正在运行
**测试步骤**:
1. 触发定时任务（到达 cron 时间）
2. 观察定时任务行为

**预期结果**:
- 定时任务检测到有任务正在运行
- 跳过本次执行
- 运行日志记录 status = 'skipped'
- message = "已有任务正在运行"

**风险**: 高 - 互斥控制

---

#### TC-CRON-008: 无效的 cron 表达式

**优先级**: P2
**前置条件**: 无
**测试步骤**:
1. 发送 `PUT /api/market-data/cron/config`
2. 请求体包含无效的 cron 表达式（如 "invalid"）

**预期结果**:
- HTTP 状态码: 400
- 响应: `{"error": "无效的 cron 表达式"}`
- 配置未更新

**风险**: 中 - 输入验证

---

## 7. 数据分析一致性测试

### 7.1 测试目标

验证数据分析的幂等性，多次触发分析结果一致，自动触发机制正确。

### 7.2 测试用例

#### TC-ANALYZE-001: 多次触发分析，结果一致（幂等）

**优先级**: P0
**前置条件**: bundle 目录已存在且有数据
**测试步骤**:
1. 手动触发分析，记录结果
2. 等待分析完成
3. 再次手动触发分析，记录结果
4. 比较两次结果

**预期结果**:
- 两次分析的统计数据完全一致:
  - total_files
  - total_size_bytes
  - stock_count
  - fund_count
  - futures_count
  - index_count
  - bond_count
- last_modified 时间一致（bundle 未变化）
- analyzed_at 时间不同（记录分析时间）

**验证点**:
- 数据库查询: `SELECT * FROM market_data_stats WHERE id = 1`
- 统计数据一致

**风险**: 高 - 数据准确性

---

#### TC-ANALYZE-002: 分析后统计数据正确写入数据库

**优先级**: P0
**前置条件**: bundle 目录已存在且有数据
**测试步骤**:
1. 手动触发分析
2. 等待分析完成
3. 查询数据库

**预期结果**:
- `market_data_stats` 表有且仅有一条记录（id = 1）
- bundle_path 正确
- last_modified 为 bundle 中最新文件的修改时间
- total_files > 0
- total_size_bytes > 0
- 各品种数据条数 >= 0
- analyzed_at 为分析完成时间

**验证点**:
- 单行表约束生效
- 数据完整性

**风险**: 高 - 数据准确性

---

#### TC-ANALYZE-003: 全量下载后自动触发分析

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 触发全量下载
2. 等待下载和解压完成
3. 观察任务状态

**预期结果**:
- 下载任务完成后，自动创建新的分析任务
- 分析任务的 source = 'auto'
- 分析任务正常执行
- 任务日志中记录"已提交分析任务"

**验证点**:
- 任务表中有两条记录：一条 full，一条 analyze
- 调用链正确

**风险**: 高 - 自动化流程

---

#### TC-ANALYZE-004: 增量更新后自动触发分析

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 触发增量更新
2. 等待更新完成
3. 观察任务状态

**预期结果**:
- 更新任务完成后，自动创建新的分析任务
- 分析任务的 source = 'auto'
- 分析任务正常执行

**风险**: 高 - 自动化流程

---

#### TC-ANALYZE-005: 定时任务完成后自动触发分析

**优先级**: P0
**前置条件**: 定时任务已启用
**测试步骤**:
1. 等待定时任务触发
2. 等待任务完成
3. 观察任务状态

**预期结果**:
- 定时任务完成后，自动创建新的分析任务
- 分析任务的 source = 'auto'
- 分析任务正常执行

**风险**: 高 - 自动化流程

---

#### TC-ANALYZE-006: 分析失败不影响现有数据

**优先级**: P1
**前置条件**: 数据库中已有统计数据
**测试步骤**:
1. 记录当前统计数据
2. 模拟分析失败（如修改 bundle 路径为无效路径）
3. 触发分析
4. 等待分析失败
5. 查询数据库

**预期结果**:
- 分析任务状态为 'failed'
- 数据库中的统计数据未被修改（保持原值）
- 不产生脏数据

**验证点**:
- 统计数据与步骤1一致

**风险**: 中 - 数据完整性

---

## 8. 失败场景测试

### 8.1 测试目标

验证系统在各种失败场景下的错误处理、状态管理和恢复能力。

### 8.2 测试用例

#### TC-FAIL-001: 网络中断时下载失败

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 触发全量下载或增量更新
2. 在下载过程中模拟网络中断（断开网络连接或使用防火墙规则）
3. 观察任务状态

**预期结果**:
- 任务状态变为 'failed'
- error 字段记录网络错误信息
- 任务日志记录失败原因
- 临时文件被清理（如果有）
- 不影响现有 bundle 数据

**验证点**:
- 任务表: status = 'failed'
- 临时文件 `/tmp/rqalpha_bundle.zip` 不存在

**风险**: 高 - 网络不稳定场景

---

#### TC-FAIL-002: 解压失败

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 准备一个损坏的 zip 文件
2. 模拟下载该文件（或直接放置到临时路径）
3. 触发解压
4. 观察任务状态

**预期结果**:
- 任务状态变为 'failed'
- error 字段记录解压错误信息
- 任务日志记录失败原因
- 临时 zip 文件被清理
- 不影响现有 bundle 数据

**验证点**:
- 任务表: status = 'failed', stage = 'unzip'
- 临时文件已清理

**风险**: 高 - 数据完整性

---

#### TC-FAIL-003: Bundle 目录权限异常

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 修改 bundle 目录权限为只读（chmod 444）
2. 触发全量下载或增量更新
3. 观察任务状态

**预期结果**:
- 任务状态变为 'failed'
- error 字段记录权限错误信息
- 任务日志记录"权限被拒绝"
- 前端显示友好错误提示

**验证点**:
- 错误消息包含 "Permission denied" 或类似信息

**风险**: 高 - 部署配置问题

---

#### TC-FAIL-004: RQAlpha 解析异常

**优先级**: P1
**前置条件**: bundle 目录存在但数据格式异常
**测试步骤**:
1. 在 bundle 目录中放置格式错误的数据文件
2. 触发数据分析
3. 观察任务状态

**预期结果**:
- 任务状态变为 'failed'
- error 字段记录解析错误信息
- 任务日志记录具体的解析错误
- 不影响数据库中现有的统计数据

**验证点**:
- 任务表: status = 'failed', stage = 'analyze'
- 统计表数据未被破坏

**风险**: 中 - 数据格式问题

---

#### TC-FAIL-005: 失败任务可重试

**优先级**: P0
**前置条件**: 有一个失败的任务
**测试步骤**:
1. 获取失败任务的 task_id
2. 发送 `POST /api/market-data/tasks/{task_id}/retry`
3. 观察响应

**预期结果**:
- HTTP 状态码: 202
- 返回新的 task_id
- 新任务开始执行
- 新任务的 source = 'retry'

**验证点**:
- 新任务记录已创建
- 任务类型与原任务一致

**风险**: 高 - 恢复能力

---

#### TC-FAIL-006: 只能重试失败的任务

**优先级**: P1
**前置条件**: 有一个成功或正在运行的任务
**测试步骤**:
1. 尝试重试该任务
2. 观察响应

**预期结果**:
- HTTP 状态码: 400
- 响应: `{"error": "只能重试失败的任务"}`

**风险**: 中 - 业务逻辑

---

#### TC-FAIL-007: 下载失败后临时文件清理

**优先级**: P1
**前置条件**: 无
**测试步骤**:
1. 触发全量下载
2. 在下载过程中模拟失败
3. 检查临时文件

**预期结果**:
- `/tmp/rqalpha_bundle.zip` 不存在
- 不留下任何临时文件

**验证点**:
- 文件系统检查

**风险**: 中 - 资源清理

---

#### TC-FAIL-008: 数据库连接失败

**优先级**: P2
**前置条件**: 无
**测试步骤**:
1. 模拟数据库不可用（如修改数据库路径）
2. 触发任何操作
3. 观察响应

**预期结果**:
- HTTP 状态码: 500
- 响应: `{"error": "数据库连接失败"}`
- 应用不崩溃

**风险**: 中 - 基础设施问题

---

## 9. API 测试

### 9.1 测试目标

验证所有 API 端点的正确性、安全性和错误处理。

### 9.2 测试用例

#### TC-API-001: 所有端点需要认证

**优先级**: P0
**前置条件**: 用户未登录
**测试步骤**:
1. 不带认证信息访问以下端点：
   - GET /api/market-data/overview
   - POST /api/market-data/analyze
   - POST /api/market-data/download/incremental
   - POST /api/market-data/download/full
   - GET /api/market-data/tasks/{task_id}
   - GET /api/market-data/cron/config
   - PUT /api/market-data/cron/config
   - GET /api/market-data/cron/logs

**预期结果**:
- 所有请求返回 HTTP 401 Unauthorized
- 响应: `{"error": "未授权"}`

**验证点**:
- @auth_required 装饰器生效

**风险**: 高 - 安全性

---

#### TC-API-002: GET /api/market-data/overview 正常响应

**优先级**: P0
**前置条件**: 用户已登录，数据已分析
**测试步骤**:
1. 发送 GET 请求

**预期结果**:
- HTTP 状态码: 200
- 响应包含:
  - analyzed: true
  - data: {...统计数据}

**风险**: 高 - 核心功能

---

#### TC-API-003: GET /api/market-data/overview 未分析时响应

**优先级**: P1
**前置条件**: 用户已登录，数据未分析
**测试步骤**:
1. 发送 GET 请求

**预期结果**:
- HTTP 状态码: 200
- 响应:
  ```json
  {
    "analyzed": false,
    "message": "尚未分析数据，请先触发数据分析"
  }
  ```

**风险**: 中 - 用户体验

---

#### TC-API-004: POST /api/market-data/analyze 正常响应

**优先级**: P0
**前置条件**: 用户已登录，无正在运行的任务
**测试步骤**:
1. 发送 POST 请求

**预期结果**:
- HTTP 状态码: 202
- 响应: `{"task_id": "uuid"}`

**风险**: 高 - 核心功能

---

#### TC-API-005: GET /api/market-data/tasks/{task_id} 正常响应

**优先级**: P0
**前置条件**: 任务已存在
**测试步骤**:
1. 发送 GET 请求

**预期结果**:
- HTTP 状态码: 200
- 响应包含完整的任务信息

**风险**: 高 - 核心功能

---

#### TC-API-006: GET /api/market-data/tasks/{task_id} 任务不存在

**优先级**: P1
**前置条件**: 任务不存在
**测试步骤**:
1. 使用不存在的 task_id 发送 GET 请求

**预期结果**:
- HTTP 状态码: 404
- 响应: `{"error": "任务不存在"}`

**风险**: 中 - 错误处理

---

#### TC-API-007: 错误码定义准确

**优先级**: P1
**前置条件**: 无
**测试步骤**:
1. 测试各种场景，验证错误码

**预期结果**:
- 200: 成功
- 202: 任务已提交
- 400: 请求参数错误
- 404: 资源不存在
- 409: 冲突（任务互斥）
- 500: 服务器内部错误

**风险**: 中 - API 规范

---

## 10. 数据库测试

### 10.1 测试目标

验证数据库表结构、约束、索引和数据完整性。

### 10.2 测试用例

#### TC-DB-001: 任务表正确记录任务状态

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 触发一个任务
2. 查询任务表

**预期结果**:
- 任务记录已创建
- 所有字段正确填充
- task_id 为 UUID 格式
- created_at 为 ISO 8601 格式

**验证点**:
- SQL: `SELECT * FROM market_data_tasks WHERE task_id = ?`

**风险**: 高 - 数据完整性

---

#### TC-DB-002: 任务日志表正确记录操作日志

**优先级**: P1
**前置条件**: 任务正在执行
**测试步骤**:
1. 等待任务执行
2. 查询日志表

**预期结果**:
- 日志记录已创建
- 包含 task_id、timestamp、level、message
- 日志按时间顺序排列

**验证点**:
- SQL: `SELECT * FROM market_data_task_logs WHERE task_id = ? ORDER BY timestamp`

**风险**: 中 - 可观测性

---

#### TC-DB-003: 统计表单行约束生效

**优先级**: P0
**前置条件**: 无
**测试步骤**:
1. 尝试插入第二条统计记录（id = 2）
2. 观察结果

**预期结果**:
- 插入失败
- 数据库返回约束错误

**验证点**:
- CHECK 约束: `id = 1`

**风险**: 高 - 数据一致性

---

#### TC-DB-004: 统计表幂等更新

**优先级**: P0
**前置条件**: 统计表已有数据
**测试步骤**:
1. 执行 INSERT OR REPLACE
2. 查询统计表

**预期结果**:
- 只有一条记录
- 数据已更新

**验证点**:
- SQL: `SELECT COUNT(*) FROM market_data_stats` = 1

**风险**: 高 - 幂等性

---

#### TC-DB-005: 定时任务配置表单行约束

**优先级**: P1
**前置条件**: 无
**测试步骤**:
1. 尝试插入第二条配置记录（id = 2）
2. 观察结果

**预期结果**:
- 插入失败
- 数据库返回约束错误

**风险**: 中 - 数据一致性

---

#### TC-DB-006: 索引正确创建

**优先级**: P2
**前置条件**: 数据库已初始化
**测试步骤**:
1. 查询数据库索引

**预期结果**:
- idx_tasks_created 存在
- idx_tasks_status 存在
- idx_logs_task 存在
- idx_logs_timestamp 存在
- idx_cron_logs_time 存在

**验证点**:
- SQL: `SELECT name FROM sqlite_master WHERE type='index'`

**风险**: 低 - 性能优化

---

## 11. 路径与权限测试

### 11.1 测试目标

验证 bundle 路径配置、容器内路径权限和 Docker volume 挂载。

### 11.2 测试用例

#### TC-PATH-001: Bundle 路径配置正确

**优先级**: P0
**前置条件**: 应用已启动
**测试步骤**:
1. 检查环境变量 RQALPHA_BUNDLE_PATH
2. 验证路径值

**预期结果**:
- 环境变量存在
- 值为 `/data/rqalpha/bundle`

**验证点**:
- `echo $RQALPHA_BUNDLE_PATH`

**风险**: 高 - 配置正确性

---

#### TC-PATH-002: 容器内路径可读写

**优先级**: P0
**前置条件**: 应用已启动
**测试步骤**:
1. 在容器内测试路径权限
2. 尝试创建测试文件

**预期结果**:
- 路径存在
- 可读可写
- 测试文件创建成功

**验证点**:
- `touch /data/rqalpha/bundle/test.txt && rm /data/rqalpha/bundle/test.txt`

**风险**: 高 - 基础功能

---

#### TC-PATH-003: Docker Volume 挂载正常

**优先级**: P0
**前置条件**: Docker 容器已启动
**测试步骤**:
1. 检查 Docker volume
2. 验证挂载点

**预期结果**:
- volume `rqalpha_bundle` 存在
- 挂载到容器的 `/data/rqalpha/bundle`

**验证点**:
- `docker volume ls | grep rqalpha_bundle`
- `docker inspect <container> | grep Mounts`

**风险**: 高 - 数据持久化

---

#### TC-PATH-004: 应用启动时路径验证

**优先级**: P1
**前置条件**: 无
**测试步骤**:
1. 删除 bundle 目录
2. 启动应用
3. 观察日志

**预期结果**:
- 应用自动创建 bundle 目录
- 或日志中记录路径验证信息

**验证点**:
- 应用日志

**风险**: 中 - 自动化配置

---

## 12. 测试执行计划

### 12.1 测试阶段

#### 阶段 1: 单元测试（开发阶段）
- 任务管理器单元测试
- 数据分析函数单元测试
- 工具函数单元测试
- 覆盖率目标: ≥70%

#### 阶段 2: 集成测试（开发完成后）
- API 端点集成测试
- 数据库集成测试
- 任务流程集成测试
- 覆盖率目标: ≥80%

#### 阶段 3: 系统测试（功能测试）
- 执行本文档中的所有测试用例
- P0 和 P1 用例必须全部通过
- P2 和 P3 用例通过率 ≥90%

#### 阶段 4: 回归测试（每次发布前）
- 执行非回归测试（第 2 节）
- 执行 P0 用例
- 执行关键 P1 用例

### 12.2 测试优先级分布

| 优先级 | 用例数 | 执行频率 | 通过标准 |
|--------|--------|----------|----------|
| P0     | 45     | 每次提交 | 100%     |
| P1     | 25     | PR 合并前 | ≥95%     |
| P2     | 8      | 每日回归 | ≥90%     |
| P3     | 0      | 按需执行 | 参考     |

### 12.3 测试环境要求

**硬件要求**:
- CPU: 2 核
- 内存: 4GB
- 磁盘: 20GB

**软件要求**:
- Docker 20.10+
- Python 3.11+
- Flask 3.1.2
- SQLite3
- APScheduler 3.10.4

**测试数据**:
- 小规模 bundle 数据（用于快速测试）
- 完整 bundle 数据（用于性能测试）

### 12.4 测试工具

- **API 测试**: pytest + requests
- **数据库测试**: pytest + sqlite3
- **前端测试**: Playwright 或 Cypress
- **性能测试**: locust 或 JMeter
- **覆盖率**: pytest-cov

---

## 13. 风险评估与缓解

### 13.1 高风险项

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 任务互斥失败导致数据竞争 | 高 | 严格测试并发场景，使用数据库锁 |
| 下载失败导致 bundle 损坏 | 高 | 使用临时文件，原子性操作 |
| 权限配置错误导致功能不可用 | 高 | 启动时验证路径权限 |
| 非回归测试失败 | 高 | 每次提交前执行冒烟测试 |

### 13.2 中风险项

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 进度追踪不准确 | 中 | 详细测试进度更新逻辑 |
| 定时任务配置错误 | 中 | 验证 cron 表达式格式 |
| 日志记录不完整 | 中 | 测试各种场景的日志输出 |

---

## 14. 测试交付物

### 14.1 测试文档
- [x] 测试计划（本文档）
- [ ] 测试用例详细说明
- [ ] 测试执行报告
- [ ] 缺陷报告

### 14.2 自动化测试代码
- [ ] 单元测试代码
- [ ] 集成测试代码
- [ ] API 测试代码
- [ ] E2E 测试代码

### 14.3 测试数据
- [ ] 测试用 bundle 数据
- [ ] 测试数据库 fixtures
- [ ] Mock 数据

---

## 15. 测试完成标准

### 15.1 功能完成标准
- [ ] 所有 P0 用例通过率 100%
- [ ] 所有 P1 用例通过率 ≥95%
- [ ] 所有 P2 用例通过率 ≥90%
- [ ] 非回归测试全部通过
- [ ] 无高优先级缺陷

### 15.2 质量完成标准
- [ ] 代码覆盖率 ≥70%
- [ ] API 响应时间 < 2 秒（P95）
- [ ] 无安全漏洞
- [ ] 无内存泄漏
- [ ] 日志完整且有意义

### 15.3 文档完成标准
- [ ] 测试计划已审核
- [ ] 测试报告已生成
- [ ] 缺陷已记录并跟踪
- [ ] 用户手册已更新

---

## 16. 附录

### 16.1 测试用例统计

| 类别 | P0 | P1 | P2 | P3 | 总计 |
|------|----|----|----|----|------|
| 非回归测试 | 3 | 1 | 0 | 0 | 4 |
| 当月已最新弹框 | 4 | 2 | 0 | 0 | 6 |
| 进度追踪 | 4 | 2 | 0 | 0 | 6 |
| 任务互斥 | 3 | 2 | 0 | 0 | 5 |
| 定时任务配置 | 3 | 3 | 2 | 0 | 8 |
| 数据分析一致性 | 5 | 1 | 0 | 0 | 6 |
| 失败场景 | 4 | 3 | 1 | 0 | 8 |
| API 测试 | 4 | 3 | 0 | 0 | 7 |
| 数据库测试 | 3 | 2 | 1 | 0 | 6 |
| 路径与权限 | 3 | 1 | 0 | 0 | 4 |
| **总计** | **36** | **20** | **4** | **0** | **60** |

### 16.2 参考文档

- PRD: `_bmad-output/prd-market-data-mgmt.md`
- 架构设计: `_bmad-output/arch-market-data-mgmt.md`
- Product Brief: `_bmad-output/brief-market-data-mgmt.md`

### 16.3 测试联系人

- **测试负责人**: wallace
- **开发负责人**: wallace
- **产品负责人**: wallace

---

**文档版本**: 1.0
**最后更新**: 2026-02-26
**状态**: Draft

---

**生成工具**: BMad TEA Agent - Test Architect Module
**工作流**: `_bmad/tea/workflows/testarch/test-design`
