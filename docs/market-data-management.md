# 行情数据管理功能使用指南

## 概述

行情数据管理功能为 RQAlpha 行情数据包（bundle）提供可视化管理界面，支持数据查看、手动下载和定时任务配置。

## 功能说明

### 1. 数据全景

查看当前 bundle 的统计信息：
- 下载时间
- 总文件数和总大小
- 最近修改时间
- 各品种行情条数（股票、基金、期货、指数、债券）

**操作步骤**：
1. 点击导航栏"行情数据管理"
2. 默认进入"数据全景"页面
3. 点击"触发分析"按钮手动更新统计数据

### 2. 手动下载

支持两种下载方式：

#### 增量更新
- 使用 `rqalpha update-bundle` 命令
- 数据追加到现有 bundle
- 适用于日常更新

**操作步骤**：
1. 进入"手动下载"页面
2. 点击"增量更新"按钮
3. 如果当月已更新，会弹出确认对话框
4. 确认后开始下载，实时显示进度

#### 全量下载
- 下载完整的 bundle 压缩包
- 解压到 bundle 目录
- 适用于首次安装或数据重建

**操作步骤**：
1. 进入"手动下载"页面
2. 点击"全量下载"按钮
3. 如果当月已更新，会弹出确认对话框
4. 确认后开始下载和解压，实时显示进度

### 3. 下载配置

配置定时任务自动更新数据。

**操作步骤**：
1. 进入"下载配置"页面
2. 勾选"启用定时任务"
3. 设置 Cron 表达式（如 `0 2 1 * *` 表示每月1日凌晨2点）
4. 选择任务类型（增量更新或全量下载）
5. 点击"保存配置"

**Cron 表达式示例**：
- `0 2 1 * *` - 每月1日凌晨2点
- `0 3 * * 0` - 每周日凌晨3点
- `0 4 1,15 * *` - 每月1日和15日凌晨4点

**查看运行日志**：
- 在"下载配置"页面下方查看定时任务运行历史
- 日志显示触发时间、状态、任务ID和消息

## 注意事项

1. **任务互斥**：同一时间只能运行一个任务（下载/解压/分析）
2. **当月已最新**：如果 bundle 在当月已更新，系统会提示确认
3. **自动分析**：下载或更新完成后会自动触发数据分析
4. **权限要求**：所有操作需要登录后才能执行

## 故障排查

### 问题1：下载失败
- 检查网络连接
- 查看任务进度中的错误信息
- 等待任务失败后可使用"重试"功能

### 问题2：解压失败
- 检查磁盘空间是否充足
- 检查 bundle 目录权限
- 查看任务日志了解具体错误

### 问题3：分析失败
- 检查 bundle 目录是否存在
- 检查数据文件格式是否正确
- 重新触发分析

### 问题4：定时任务未执行
- 检查定时任务是否已启用
- 检查 Cron 表达式是否正确
- 查看运行日志了解跳过原因（如已有任务运行）

## API 参考

所有 API 端点都需要认证（Bearer Token）。

### 获取数据全景
```
GET /api/market-data/overview
```

### 触发数据分析
```
POST /api/market-data/analyze
```

### 触发增量更新
```
POST /api/market-data/download/incremental
Body: { "force": false }
```

### 触发全量下载
```
POST /api/market-data/download/full
Body: { "force": false }
```

### 查询任务状态
```
GET /api/market-data/tasks/{task_id}
```

### 获取定时任务配置
```
GET /api/market-data/cron/config
```

### 更新定时任务配置
```
PUT /api/market-data/cron/config
Body: {
  "enabled": true,
  "cron_expression": "0 2 1 * *",
  "task_type": "incremental"
}
```

### 获取定时任务日志
```
GET /api/market-data/cron/logs?limit=20&offset=0
```
